#!/usr/bin/env ruby

require "sqlite3"
require "fileutils"
require "pathname"
require "json"
require "pp"

class MainDb
  def initialize(path)
    @path = path
    @db = SQLite3::Database.new(path)
  end
  def get_data(query)
    columns, *rows = @db.execute2(query)
    rv = []
    rows.each do |row|
      ht = {}
      (0...columns.size).each do |i|
        ht[columns[i]] = row[i] unless row[i].nil?
      end
      rv << ht
    end
    rv
  end
  def account_data
    get_data("select * from Accounts")
  end
  def contact_data
    get_data("select * from Contacts")
  end
end

class ExportDirectoryBuilder
  def initialize(path)
    @path = Pathname(path)
  end
  def prepare!
    @path.rmtree if @path.exist?
    @path.mkpath
  end
  def save_binary_file!(file_name, data)
    file_path = @path + file_name
    file_path.dirname.mkpath
    file_path.open('wb') do |fh|
      fh.write(data)
    end
    file_path
  end
  def save_profile_attachments!(skype_name, data)
    path_end_idx = 12+data[12..-1].index("\x00")
    path = data[12...path_end_idx]
    image_start_idx = path_end_idx+1+data[path_end_idx+1..-1].index("\x00")
    image = data[image_start_idx+1..-1]
    warn "Attachment isn't called MyAvatar" unless path == "profile://#{skype_name}/MyAvatar"
    warn "Attachment for #{skype_name} doesn't look like JPEG image" unless image[0,4].bytes == "\xFF\xD8\xFF\xE0".bytes
    save_binary_file!("attachments/#{skype_name}.jpg", image)
  end
  def save_avatar!(skype_name, data)
    warn "Avatar for #{skype_name} might be incorrect" unless data[0, 5].bytes == "\x00\xFF\xD8\xFF\xE0".bytes
    save_binary_file!("avatars/#{skype_name}.jpg", data[1..-1])
  end
  def save_text_file!(file_name, data, converter)
    (@path + file_name).open('w') do |fh|
      data.each_with_index do |row, i|
        send(converter, row) do |key, val|
          fh.puts "#{key}: #{val}"
        end
        fh.puts "" unless i == data.size-1
      end
    end
  end
  # accounts and contacts are very similar, so use the same code for both
  def convert_account(row)
    row.each do |key, val|
      case key
      when "capabilities",
           "synced_email",
           "cbl_profile_blob",
           "authorization_certificate",
           "saved_directory_blob",
           "buddyblob"
        # pass
      when "avatar_image"
        yield key, save_avatar!(row["skypename"], val)
      when "profile_attachments"
        yield key, save_profile_attachments!(row["skypename"], val)
      else
        yield key, val.inspect
      end
    end
  end
  def export_accounts!(data)
    save_text_file!("accounts.txt", data, :convert_account) unless data.empty?
  end
  def export_contacts!(data)
    save_text_file!("contacts.txt", data, :convert_account) unless data.empty?
  end
end

class SkypeExporter
  def initialize(db_path, output_path)
    @db = MainDb.new(db_path)
    @out = ExportDirectoryBuilder.new(output_path)
  end

  def export!
    @out.prepare!
    @out.export_accounts! @db.account_data
    @out.export_contacts! @db.contact_data
  end
end

se = SkypeExporter.new("main.db", "output")
se.export!
